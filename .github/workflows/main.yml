name: eBay Order Fetch & OAuth Token Refresh

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 */2 * * *"  # âœ… 2ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # âœ… ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  refresh-ebay-token:
    name: "ğŸ”„ Refresh eBay OAuth Token"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install Dependencies
        run: pip install requests python-dotenv jq

      - name: ğŸ” Debug GitHub Secrets (ë³´ì•ˆ ì¤‘ìš”: ì‹¤í–‰ í›„ ì œê±°)
        run: |
          echo "ğŸ” EBAY_CLIENT_ID=${{ secrets.EBAY_CLIENT_ID }}"
          echo "ğŸ” EBAY_CLIENT_SECRET=${{ secrets.EBAY_CLIENT_SECRET }}"
          echo "ğŸ” EBAY_REFRESH_TOKEN=${{ secrets.EBAY_REFRESH_TOKEN }}"

      - name: ğŸ”‘ Fetch New eBay OAuth Token
        env:
          EBAY_CLIENT_ID: ${{ secrets.EBAY_CLIENT_ID }}
          EBAY_CLIENT_SECRET: ${{ secrets.EBAY_CLIENT_SECRET }}
          EBAY_REFRESH_TOKEN: ${{ secrets.EBAY_REFRESH_TOKEN }}
        run: |
          echo "ğŸ”„ eBay Access Token ê°±ì‹  ì¤‘..."
          TOKEN_URL="https://api.ebay.com/identity/v1/oauth2/token"

          # âœ… base64 ì¸ì½”ë”© ì˜¤ë¥˜ ë°©ì§€ (ë¶ˆí•„ìš”í•œ ê°œí–‰ ì œê±°)
          AUTH_HEADER=$(echo -n "${EBAY_CLIENT_ID}:${EBAY_CLIENT_SECRET}" | base64 | tr -d '\n')

          RESPONSE=$(curl -s -X POST $TOKEN_URL \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -H "Authorization: Basic $AUTH_HEADER" \
            --data-urlencode "grant_type=refresh_token" \
            --data-urlencode "refresh_token=${EBAY_REFRESH_TOKEN}" \
            --data-urlencode "scope=https://api.ebay.com/oauth/api_scope")

          echo "ğŸ“Œ API ì‘ë‹µ: $RESPONSE"  # âœ… ë””ë²„ê¹…ìš© ì¶œë ¥

          ACCESS_TOKEN=$(echo $RESPONSE | jq -r '.access_token')

          if [[ "$ACCESS_TOKEN" == "null" || -z "$ACCESS_TOKEN" ]]; then
            echo "âŒ Access Token ê°±ì‹  ì‹¤íŒ¨: $RESPONSE"
            exit 1
          fi

          echo "âœ… eBay Access Token ê°±ì‹  ì™„ë£Œ!"
          echo "::add-mask::$ACCESS_TOKEN"  # âœ… GitHub Actionsì—ì„œ ë³´ì•ˆ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬
          echo "EBAY_USER_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV  # âœ… í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥

  fetch-ebay-orders:
    name: "ğŸ“¦ Fetch eBay Orders"
    runs-on: ubuntu-latest
    needs: refresh-ebay-token  # âœ… OAuth í† í° ê°±ì‹  í›„ ì‹¤í–‰

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install Dependencies
        run: pip install requests python-dotenv jq

      - name: ğŸ“¦ Fetch eBay Order Data
        env:
          EBAY_USER_TOKEN: ${{ env.EBAY_USER_TOKEN }}  # âœ… ê°±ì‹ ëœ í† í° ì‚¬ìš©
        run: python input_test.py
